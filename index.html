<!DOCTYPE html>
<html>
	<head>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>
        <script src="config.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" />
		<title>WiAttend</title>
		<script>
            $(document).ready(() => {
                let $wsStatus = $('.ws-status');
                let $tags = $('.tags');

                let $tag = tag => $('<li />')
                    .addClass('tag')
                    .attr('id', 'tag-' + tag.id)
                    .append(
                        $('<div />').addClass('name')
                        .append($('<span />').addClass('fname').append(tag.first_name))
                        .append($('<span />').addClass('lname').append(tag.last_name))
                    )
                    .append($('<div />').addClass('uid').append(tag.uid))
                    .addClass(tag.present_status === 1 ? 'present' : 'absent');

                let ws = new WebSocket('ws://' + config.wiattendServerUrl);

                ws.onopen = () => { $wsStatus.removeClass('closed').addClass('opened').find('.title').html('Connected'); };
                ws.onclose = () => { $wsStatus.removeClass('opened').addClass('closed').find('.title').html('Disconnected'); };

                ws.onmessage = e => {
                    let msg = JSON.parse(e.data);

                    if(msg.event === 'logged') {
                        let tag = msg.data;

                        $tags.find('[id="tag-' + tag.id + '"]')
                            .removeClass('present')
                            .removeClass('absent')
                            .addClass(tag.next_direction === 1 ? 'present' : 'absent');
                    }
                };

                $.getJSON('http://' + config.wiattendServerUrl + '/tags', res => {
                    res.data.forEach(tag => $tags.append($tag(tag)));
                });
            });
		</script>
	</head>
	<body>
        <div>
            <h1 class="title">WiAttend</h1>
            <div class="ws-status">
                <span class="ico"></span>
                <span class="title">Connecting to server...</span>
            </div>
            <ul class="tags clearfix"></ul>
        </div>
	</body>
</html>